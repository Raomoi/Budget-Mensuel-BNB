<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget mensuel</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="./icon-192.png">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--ok:#10b981;--bad:#ef4444;--accent:#38bdf8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:white;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{max-width:900px;margin:auto;padding:24px}
    h1{font-size:24px;margin:0 0 4px}
    h2{font-size:18px;margin:0 0 10px}
    .small{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);margin-bottom:16px}
    @media(min-width:720px){.grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:white}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0b1220;border:1px solid #1f2937;color:#cbd5e1;font-size:12px}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-weight:700;font-size:20px}
    .kpi.bad .v{color:var(--bad)}
    .kpi.ok .v{color:var(--ok)}
    .btn{background:var(--accent);color:#001018;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#0b1220;color:#e2e8f0;border:1px solid #1f2937}
    .hr{height:1px;background:#1f2937;margin:12px 0}
    .sub{font-size:13px;color:#cbd5e1;opacity:.9}
    .toggle{display:flex;align-items:center;gap:10px;font-size:13px}
    .toggle input{width:auto}
    .details{display:none;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;white-space:pre-wrap}
    .details.show{display:block}
    .footer{opacity:.7;font-size:12px;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üßÆ Budget mensuel</h1>
  <div class="small" id="last_calc">Dernier calcul : ‚Äî</div>

  <!-- Toggle d√©tails -->
  <div class="card">
    <div class="toggle">
      <input type="checkbox" id="toggle_details" />
      <label for="toggle_details">Afficher le d√©tail des calculs</label>
    </div>
  </div>

  <!-- Param√®tres -->
  <div class="card">
    <details>
      <summary class="pill">Param√®tres (personnalisables)</summary>
      <div class="grid2" style="margin-top:12px">
        <div><label>Heures / m√©nage (petit)</label><input type="number" id="h_petit" step="0.5" /></div>
        <div><label>Heures / m√©nage (grand)</label><input type="number" id="h_grand" step="0.5" /></div>
        <div><label>Taux horaire m√©nage (‚Ç¨)</label><input type="number" id="taux" step="0.01" /></div>
        <div><label>Provision m√©nage par d√©faut (‚Ç¨)</label><input type="number" id="min_menage" step="0.01" /></div>
        <div><label>Charges fixes mensuelles r√©serv√©es (‚Ç¨)</label><input type="number" id="charges_fixes" step="0.01" /></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn secondary" id="reset">R√©initialiser param√®tres</button>
        <button class="btn" id="save">Sauvegarder param√®tres</button>
      </div>
    </details>
  </div>

  <!-- 1) M√©nage -->
  <div class="card">
    <h2>1) Calcul du m√©nage</h2>
    <div class="sub">Entre le nombre de s√©jours de chaque appartement.</div>
    <div class="grid2" style="margin-top:8px">
      <div><label>S√©jours petit appart</label><input type="number" step="1" id="sejours_petit" /></div>
      <div><label>S√©jours grand appart</label><input type="number" step="1" id="sejours_grand" /></div>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="kpi"><div class="t">Heures petit</div><div class="v" id="h_petit_kpi">0 h</div></div>
      <div class="kpi"><div class="t">Heures grand</div><div class="v" id="h_grand_kpi">0 h</div></div>
      <div class="kpi"><div class="t">Heures totales</div><div class="v" id="h_tot">0 h</div></div>
      <div class="kpi"><div class="t">Co√ªt m√©nage</div><div class="v" id="budget_menage">‚Ç¨ 0,00</div></div>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="kpi" id="delta_kpi"><div class="t">√âcart vs provision m√©nage</div><div class="v" id="delta_menage">‚Ç¨ 0,00</div></div>
      <div class="kpi"><div class="t">Provision utilis√©e</div><div class="v" id="min_menage_kpi">‚Ç¨ 0,00</div></div>
    </div>
    <div id="details_menage" class="details"></div>
  </div>

  <!-- 2) Chiffre d'affaires -->
  <div class="card">
    <h2>2) Calcul du CA</h2>
    <div class="sub">Bas√© sur les donn√©es Airbnb du mois en cours.</div>
    <div class="grid2" style="margin-top:8px">
      <div><label>D√©j√† vers√© ce mois (‚Ç¨)</label><input type="number" step="0.01" id="deja_verse" /></div>
      <div><label>Reste √† verser ce mois (‚Ç¨)</label><input type="number" step="0.01" id="reste_verser" /></div>
      <div><label>Solde actuel du compte Airbnb Incomes (‚Ç¨)</label><input type="number" step="0.01" id="solde_actuel" /></div>
    </div>
    <div class="hr"></div>
    <div class="grid2">
      <div class="kpi"><div class="t">CA du mois (vers√© + √† verser)</div><div class="v" id="ca">‚Ç¨ 0,00</div></div>
      <div class="kpi"><div class="t">Solde mois pr√©c√©dent (estim√©)</div><div class="v" id="solde_prec">‚Ç¨ 0,00</div></div>
      <div class="kpi"><div class="t">Solde pr√©vu fin de mois (apr√®s charges fixes)</div><div class="v" id="fin_mois_apres_charges">‚Ç¨ 0,00</div></div>
    </div>
    <div id="details_ca" class="details"></div>
  </div>

  <!-- 3) Solde du mois -->
  <div class="card">
    <h2>3) Solde du mois</h2>
    <div class="sub">Solde pr√©vu fin de mois <b>apr√®s charges fixes et ajustement m√©nage</b>.</div>
    <div class="grid2" style="margin-top:8px">
      <div class="kpi" id="kpi_final"><div class="t">Solde fin de mois (apr√®s charges + m√©nage)</div><div class="v" id="final">‚Ç¨ 0,00</div></div>
      <div class="kpi"><div class="t">D√©tail</div><div class="v" id="note" style="font-size:14px;font-weight:500;color:#cbd5e1">‚Äî</div></div>
    </div>
    <div id="details_solde" class="details"></div>
  </div>

  <div class="footer">Tout est m√©moris√© en local. Le dernier calcul (avec date) est restaur√© √† l‚Äôouverture.</div>
</div>

<script>
const $=id=>document.getElementById(id);
const fmt=n=>(n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
const f2=n=>(n||0).toLocaleString('fr-FR');

const DEFAULTS={h_petit:2,h_grand:3,taux:29,min_menage:1050,charges_fixes:8103};
const FIELDS=['sejours_petit','sejours_grand','deja_verse','reste_verser','solde_actuel'];
const PARAMS=Object.keys(DEFAULTS);

function renderLastCalc(){
  const raw=localStorage.getItem('budget:last_calc');
  if(!raw){$("last_calc").textContent='Dernier calcul : ‚Äî';return;}
  try{
    const d=JSON.parse(raw);
    const date=new Date(d.ts);
    $("last_calc").textContent='Dernier calcul : '+date.toLocaleString('fr-FR')+
      ' ¬∑ CA '+fmt(d.ca)+' ¬∑ Œî m√©nage '+(d.delta_menage>=0?'+':'')+fmt(d.delta_menage)+
      ' ¬∑ Solde fin (apr√®s charges+m√©nage) '+fmt(d.final);
  }catch{$("last_calc").textContent='Dernier calcul : ‚Äî';}
}

function setDetailsVisible(on){["details_menage","details_ca","details_solde"].forEach(id=>$(id).classList.toggle('show',!!on));}

function compute(persist=true){
  // M√©nage
  const sp=parseInt($("sejours_petit").value)||0;
  const sg=parseInt($("sejours_grand").value)||0;
  const hp=parseFloat($("h_petit").value)||DEFAULTS.h_petit;
  const hg=parseFloat($("h_grand").value)||DEFAULTS.h_grand;
  const taux=parseFloat($("taux").value)||DEFAULTS.taux;
  const min=parseFloat($("min_menage").value)||DEFAULTS.min_menage;
  const fix=parseFloat($("charges_fixes").value)||DEFAULTS.charges_fixes;

  const hpT=sp*hp, hgT=sg*hg, hTot=hpT+hgT, cost=hTot*taux, delta=cost-min;
  $("h_petit_kpi").textContent=f2(hpT)+' h';
  $("h_grand_kpi").textContent=f2(hgT)+' h';
  $("h_tot").textContent=f2(hTot)+' h';
  $("budget_menage").textContent=fmt(cost);
  $("delta_menage").textContent=(delta>=0?'+ ':'')+fmt(delta);
  $("min_menage_kpi").textContent=fmt(min);
  const node=$("delta_kpi");node.classList.remove('ok','bad');if(delta<=0)node.classList.add('ok');else node.classList.add('bad');

  // CA
  const deja=parseFloat($("deja_verse").value)||0;
  const reste=parseFloat($("reste_verser").value)||0;
  const soldeActuel=parseFloat($("solde_actuel").value)||0;
  const ca=deja+reste;
  const soldePrec=soldeActuel-deja;           // hypoth√®se: compte d√©di√© aux versements Airbnb
  const finMoisApresCharges=soldePrec+ca-fix;

  $("ca").textContent=fmt(ca);
  $("solde_prec").textContent=fmt(soldePrec);
  $("fin_mois_apres_charges").textContent=fmt(finMoisApresCharges);

  // Solde final apr√®s m√©nage
  const final=finMoisApresCharges - delta;
  $("final").textContent=fmt(final);
  const kpi=$("kpi_final");kpi.classList.remove('ok','bad');
  let note=`Solde pr√©c. ${fmt(soldePrec)} ¬∑ CA ${fmt(ca)} ¬∑ Charges ${fmt(fix)} ¬∑ Œî m√©nage ${(delta>=0?'+':'')+fmt(delta)}`;
  if(final>=0){kpi.classList.add('ok');note='B√©n√©fice pr√©vu. '+note;}else{kpi.classList.add('bad');note='D√©ficit pr√©vu. '+note;}
  $("note").textContent=note;

  // D√©tails
  const show=$("toggle_details").checked;
  if(show){
    $("details_menage").textContent =
      `‚Äî M√©nage ‚Äî\nPetit: ${sp} √ó ${hp}h = ${f2(hpT)}h\nGrand: ${sg} √ó ${hg}h = ${f2(hgT)}h\n`+
      `Total = ${f2(hTot)}h\nCo√ªt = ${fmt(cost)}\nProvision = ${fmt(min)}\nŒî (co√ªt ‚àí provision) = ${(delta>=0?'+':'')+fmt(delta)}`;
    $("details_ca").textContent =
      `‚Äî CA ‚Äî\nD√©j√† vers√© = ${fmt(deja)}\nReste √† verser = ${fmt(reste)}\nCA du mois = ${fmt(ca)}\n`+
      `Solde actuel = ${fmt(soldeActuel)}\nSolde pr√©c. estim√© = ${fmt(soldePrec)}\n`+
      `Charges fixes = ${fmt(fix)}\nFin de mois (apr√®s charges) = ${fmt(finMoisApresCharges)}`;
    $("details_solde").textContent =
      `‚Äî Solde ‚Äî\nFin (apr√®s charges) ‚àí Œî m√©nage = ${fmt(finMoisApresCharges)} ‚àí ${(delta>=0?'+':'')+fmt(delta)} = ${fmt(final)}`;
  }

  if(persist){
    localStorage.setItem('budget:last_calc', JSON.stringify({
      ts:Date.now(), ca, delta_menage:delta, final,
      solde_prec:soldePrec, fin_apres_charges:finMoisApresCharges
    }));
    renderLastCalc();
  }
}

function load(){
  // param√®tres pr√©remplis
  PARAMS.forEach(k=>{
    const v=localStorage.getItem('budget:'+k);
    $(k).value = v!==null ? v : DEFAULTS[k];
  });
  // champs utilisateur
  FIELDS.forEach(k=>{
    const v=localStorage.getItem('budget:'+k);
    $(k).value = v!==null ? v : '';
  });
  const show=localStorage.getItem('budget:show_details')==='1';
  $("toggle_details").checked=show; setDetailsVisible(show);
  renderLastCalc(); compute(false);
}

// Listeners
PARAMS.forEach(k=>$(k).addEventListener('input',()=>compute(false)));
FIELDS.forEach(k=>$(k).addEventListener('input',e=>{
  localStorage.setItem('budget:'+k,e.target.value); compute(true);
}));
$("toggle_details").addEventListener('change',e=>{
  localStorage.setItem('budget:show_details', e.target.checked?'1':'0');
  setDetailsVisible(e.target.checked); compute(false);
});
$("save").addEventListener('click',()=>{
  PARAMS.forEach(k=>localStorage.setItem('budget:'+k,$(k).value));
  alert('Param√®tres sauvegard√©s.');
});
$("reset").addEventListener('click',()=>{
  PARAMS.forEach(k=>{localStorage.removeItem('budget:'+k);$(k).value=DEFAULTS[k];});
  compute(false);
});

renderLastCalc(); load();
</script>

<!-- Enregistrement du Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
